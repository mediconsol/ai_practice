# AI 실행 결과 저장 및 공유 기능 구현 계획

## 📌 프로젝트 개요

의료 전문가들이 AI 실행 결과를 저장하고, 우수 사례를 공유하여 집단 지성을 활용할 수 있는 기능 구현

---

## 🎯 핵심 기능

### 1. AI 실행 결과 저장
- AI 실행 화면에서 프롬프트와 결과물을 함께 저장
- 제목, 카테고리, 메모 추가 가능
- 즐겨찾기 기능

### 2. 마이페이지
- 저장된 실행 결과 관리
- 프롬프트 자산 관리
- 통계 및 프로필 정보

### 3. 공유 기능
- 개인정보 보호 체크리스트 확인 후 공유
- 다른 사용자들에게 우수 사례 공유
- 공유된 콘텐츠를 내 자산에 저장

### 4. 공유 프롬프트 섹션
- 다른 사용자들이 공유한 프롬프트/결과물 조회
- 카테고리별 필터링
- 인기순/최신순 정렬

---

## 🗄️ 데이터베이스 스키마

### execution_results 테이블

```sql
CREATE TABLE execution_results (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  title TEXT NOT NULL,
  category TEXT NOT NULL,
  prompt TEXT NOT NULL,
  result TEXT NOT NULL,
  memo TEXT,
  is_favorite BOOLEAN DEFAULT false,
  is_shared BOOLEAN DEFAULT false,

  -- AI 실행 정보
  ai_provider TEXT,  -- 'openai' | 'gemini' | 'claude'
  ai_model TEXT,
  execution_time_ms INTEGER,
  token_usage JSONB,

  -- 공유 관련
  shared_at TIMESTAMPTZ,
  view_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,

  -- 타임스탬프
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_execution_results_user_id ON execution_results(user_id);
CREATE INDEX idx_execution_results_category ON execution_results(category);
CREATE INDEX idx_execution_results_is_shared ON execution_results(is_shared);
CREATE INDEX idx_execution_results_created_at ON execution_results(created_at DESC);

-- RLS 정책
ALTER TABLE execution_results ENABLE ROW LEVEL SECURITY;

-- 본인의 결과물만 조회 가능
CREATE POLICY "Users can view own results"
  ON execution_results FOR SELECT
  USING (auth.uid() = user_id);

-- 공유된 결과물은 모든 사용자가 조회 가능
CREATE POLICY "Users can view shared results"
  ON execution_results FOR SELECT
  USING (is_shared = true);

-- 본인의 결과물만 생성 가능
CREATE POLICY "Users can insert own results"
  ON execution_results FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- 본인의 결과물만 수정 가능
CREATE POLICY "Users can update own results"
  ON execution_results FOR UPDATE
  USING (auth.uid() = user_id);

-- 본인의 결과물만 삭제 가능
CREATE POLICY "Users can delete own results"
  ON execution_results FOR DELETE
  USING (auth.uid() = user_id);
```

### shared_content_likes 테이블 (Phase 3)

```sql
CREATE TABLE shared_content_likes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  result_id UUID REFERENCES execution_results NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id, result_id)
);
```

---

## 📋 구현 단계

## Phase 1: 핵심 기능 (MVP) ✅ 완료

### ✅ Task 1.1: DB 마이그레이션
- [x] `execution_results` 테이블 생성
- [x] RLS 정책 설정
- [x] 인덱스 생성

### ✅ Task 1.2: AI 실행 결과 저장 기능
- [x] `SaveResultDialog.tsx` 컴포넌트 생성
  - 제목 입력
  - 카테고리 선택
  - 프롬프트 표시 (자동 입력, 읽기 전용)
  - 결과물 표시 (자동 입력, 읽기 전용)
  - 메모 입력 (선택)
  - 즐겨찾기 체크박스
- [x] `useSaveResult.ts` 훅 생성
  - 저장 mutation
  - 성공 시 토스트 및 쿼리 무효화
- [x] `AIExecute.tsx` 수정
  - "실행 결과 저장" 버튼 추가
  - SaveResultDialog 연동

### ✅ Task 1.3: 저장된 결과물 조회 훅
- [x] `useExecutionResults.ts` 생성
  - `useMyResults()` - 내 결과물 조회
  - `useToggleResultFavorite()` - 즐겨찾기 토글
  - `useDeleteResult()` - 결과물 삭제
  - `useUpdateResult()` - 결과물 수정

### ✅ Task 1.4: ResultCard 컴포넌트
- [x] `src/components/results/ResultCard.tsx` 생성
  - 카테고리 태그
  - 제목
  - 프롬프트 미리보기 (축약)
  - 결과물 미리보기 (스크롤 가능)
  - 메타 정보 (날짜, AI 모델, 실행 시간)
  - 버튼: 복사, 다시 실행, 더보기
  - 더보기 메뉴: 즐겨찾기, 수정, 삭제, 공유(Phase 2)

### ✅ Task 1.5: 마이페이지 생성
- [x] `src/pages/MyPage.tsx` 생성
  - 프로필 섹션 (간단히)
  - 통계 카드
    - 저장된 프롬프트 수
    - 저장된 실행 결과 수
    - 총 AI 실행 횟수
  - 탭 UI
    - "저장된 실행 결과" (기본)
    - "프롬프트 자산" (기존 Prompts 페이지 내용)
- [x] 저장된 실행 결과 섹션
  - 카테고리 필터
  - 검색 기능
  - ResultCard 그리드/리스트 뷰
  - 로딩/빈 상태 처리
- [x] 라우팅 추가 (`/my-page`)
- [x] 네비게이션에 마이페이지 링크 추가

---

## Phase 2: 공유 기능 ✅ 완료

### ✅ Task 2.1: 공유 전 개인정보 보호 체크
- [x] `ShareConfirmDialog.tsx` 생성
  - 개인정보 제거 체크리스트 (필수)
    - ✅ 환자 이름 제거 확인
    - ✅ 등록번호/차트번호 제거 확인
    - ✅ 연락처 제거 확인
    - ✅ 기타 식별 가능 정보 제거 확인
  - 공유 목적 설명 (선택)
  - 모든 항목 체크해야 공유 가능

### ✅ Task 2.2: 공유 기능 구현
- [x] `useToggleShare()` 훅 생성 (useExecutionResults.ts)
  - `shareResult(id)` - 결과물 공유
  - `unshareResult(id)` - 공유 취소
- [x] ResultCard 더보기 메뉴에 "공유" 추가
- [x] 공유 상태 표시 (공유됨 배지)

### ✅ Task 2.3: 공유 프롬프트 조회
- [x] `useSharedResults()` 훅 생성 (useExecutionResults.ts)
  - `useSharedResults()` - 공유된 결과물 조회
  - 필터: 카테고리, 정렬(최신순, 인기순)
- [x] `SharedResultCard.tsx` 컴포넌트 생성
  - 조회수/좋아요 표시
  - 버튼: 내 자산에 저장, 복사, 실행

### ✅ Task 2.4: 프롬프트 자산 페이지 개선
- [x] `Prompts.tsx` 탭 추가
  - "내 프롬프트" (기존)
  - "공유 프롬프트" (신규)
- [x] 공유 프롬프트 섹션
  - 카테고리 필터
  - 정렬 (최신순, 인기순, 좋아요순, 조회순)
  - SharedResultCard 그리드

### ✅ Task 2.5: 공유 콘텐츠를 내 자산에 저장
- [x] `useSaveSharedToMyAssets()` 훅 생성 (useExecutionResults.ts)
  - 공유 콘텐츠를 내 execution_results에 복사
  - 원작자 정보는 메모에 기록
- [x] SharedResultCard "내 자산에 저장" 버튼 연동

---

## Phase 3: 커뮤니티 기능 ✅ 완료

### ✅ Task 3.1: 좋아요 기능
- [x] `shared_content_likes` 테이블 생성
- [x] `useToggleLike()`, `useCheckLike()` 훅 생성 (useExecutionResults.ts)
- [x] SharedResultCard에 좋아요 버튼 추가
- [x] 좋아요 수 실시간 업데이트
- [x] 좋아요 상태 시각적 표시 (Heart 아이콘)

### ✅ Task 3.2: 조회수 추적
- [x] `useIncrementViewCount()` 훅 생성
- [x] 의미있는 상호작용 시 조회수 증가 (실행, 내 자산에 저장)
- [x] 에러 처리 (사일런트 실패)

### ✅ Task 3.3: 인기 콘텐츠 랭킹
- [x] 정렬 옵션 구현 (인기순, 최신순, 좋아요순, 조회순)
- [x] 인기도 계산 로직 (좋아요 × 2 + 조회수)
- [x] 정렬 UI 추가 (Prompts 페이지)

### ✅ Task 3.4: 댓글 기능 (선택)
- [ ] `result_comments` 테이블 생성 (보류)
- [ ] 댓글 CRUD 기능 (보류)
- [ ] 댓글 컴포넌트 (보류)

---

## 🔧 기술 스택

### Frontend
- React + TypeScript
- TanStack Query (React Query)
- React Router
- Tailwind CSS + shadcn/ui
- Sonner (Toast)

### Backend
- Supabase
  - PostgreSQL (데이터베이스)
  - Row Level Security (권한 관리)
  - Realtime (선택적)

---

## 📝 파일 구조

```
src/
├── components/
│   ├── results/
│   │   ├── ResultCard.tsx
│   │   ├── SharedResultCard.tsx
│   │   ├── SaveResultDialog.tsx
│   │   └── ShareConfirmDialog.tsx
│   └── ...
├── hooks/
│   ├── useExecutionResults.ts
│   ├── useMyResults.ts
│   ├── useSharedResults.ts
│   ├── useSaveResult.ts
│   ├── useShareResult.ts
│   └── useLikeResult.ts (Phase 3)
├── pages/
│   ├── MyPage.tsx (신규)
│   ├── AIExecute.tsx (수정)
│   └── Prompts.tsx (수정)
└── ...

supabase/
└── migrations/
    ├── YYYYMMDDHHMMSS_create_execution_results.sql
    └── YYYYMMDDHHMMSS_create_shared_content_likes.sql (Phase 3)
```

---

## ⚠️ 주의사항

### 개인정보 보호
1. **필수 체크리스트**: 공유 전 환자 개인정보 제거 확인 필수
2. **자동 스캔 (선택)**: 정규식으로 이름/전화번호 패턴 감지 경고
3. **공유 취소**: 언제든 공유 취소 가능
4. **신고 기능**: 부적절한 콘텐츠 신고 시스템 (추후)

### 의료 정보 정확성
1. **면책 조항**: 공유된 콘텐츠는 참고용이며, 실제 진료 시 검증 필요
2. **AI 생성 표시**: 모든 결과물에 "AI 생성 콘텐츠" 표시
3. **검증 배지 (선택)**: 전문가 검증된 콘텐츠 표시

### 저작권
1. **라이선스 명시**: 공유 시 크리에이티브 커먼즈 라이선스 적용
2. **출처 표시**: 공유 콘텐츠 재사용 시 원작자 표시

---

## 📊 진행 상황

### Phase 1: 핵심 기능 ✅ 완료
- [x] Task 1.1: DB 마이그레이션
- [x] Task 1.2: AI 실행 결과 저장 기능
- [x] Task 1.3: 저장된 결과물 조회 훅
- [x] Task 1.4: ResultCard 컴포넌트
- [x] Task 1.5: 마이페이지 생성

### Phase 2: 공유 기능 ✅ 완료
- [x] Task 2.1: 공유 전 개인정보 보호 체크
- [x] Task 2.2: 공유 기능 구현
- [x] Task 2.3: 공유 프롬프트 조회
- [x] Task 2.4: 프롬프트 자산 페이지 개선
- [x] Task 2.5: 공유 콘텐츠를 내 자산에 저장

### Phase 3: 커뮤니티 기능 ✅ 완료
- [x] Task 3.1: 좋아요 기능
- [x] Task 3.2: 조회수 추적
- [x] Task 3.3: 인기 콘텐츠 랭킹
- [ ] Task 3.4: 댓글 기능 (보류)

---

## ✨ 구현 완료 내역

### 생성된 파일 목록

**컴포넌트**:
- `src/components/results/SaveResultDialog.tsx` - 실행 결과 저장 다이얼로그
- `src/components/results/ResultCard.tsx` - 저장된 결과 카드 (내 자산)
- `src/components/results/SharedResultCard.tsx` - 공유된 결과 카드
- `src/components/results/ShareConfirmDialog.tsx` - 개인정보 보호 체크리스트 다이얼로그

**훅 (Hooks)**:
- `src/hooks/useSaveResult.ts` - 실행 결과 저장 mutation
- `src/hooks/useExecutionResults.ts` - 실행 결과 CRUD 및 공유/좋아요 기능
  - `useMyResults()` - 내 결과물 조회
  - `useSharedResults()` - 공유된 결과물 조회
  - `useUpdateResult()` - 결과물 수정
  - `useDeleteResult()` - 결과물 삭제
  - `useToggleResultFavorite()` - 즐겨찾기 토글
  - `useToggleShare()` - 공유/공유취소
  - `useSaveSharedToMyAssets()` - 공유 콘텐츠를 내 자산에 복사
  - `useToggleLike()` - 좋아요 토글
  - `useCheckLike()` - 좋아요 상태 확인
  - `useIncrementViewCount()` - 조회수 증가

**페이지**:
- `src/pages/MyPage.tsx` - 마이페이지 (프로필, 통계, 저장된 결과/프롬프트 관리)
- `src/pages/Prompts.tsx` - 프롬프트 자산 페이지 (내 프롬프트 + 공유 프롬프트 탭)
- `src/pages/AIExecute.tsx` - AI 실행 페이지 (결과 저장 버튼 추가)

**라우팅**:
- `src/App.tsx` - `/my-page` 라우트 추가
- `src/components/layout/AppSidebar.tsx` - 마이페이지 링크 추가

### 주요 기능 요약

**Phase 1: 핵심 기능**
- AI 실행 결과 저장 (제목, 카테고리, 메모, 즐겨찾기)
- 마이페이지에서 저장된 결과 관리
- 카테고리/검색 필터링
- 그리드/리스트 뷰 전환
- 복사, 재실행, 수정, 삭제 기능

**Phase 2: 공유 기능**
- 4항목 개인정보 보호 체크리스트 (필수)
- 공유/공유취소 기능
- 공유된 콘텐츠 조회 (프롬프트 자산 페이지)
- 공유 콘텐츠를 내 자산에 저장
- 공유 상태 배지 표시

**Phase 3: 커뮤니티 기능**
- 좋아요/좋아요 취소 기능
- Heart 아이콘으로 좋아요 상태 시각화
- 조회수 자동 추적 (실행, 저장 시)
- 인기도 기반 정렬 (좋아요 × 2 + 조회수)
- 4가지 정렬 옵션 (인기순, 최신순, 좋아요순, 조회순)

### 데이터베이스 스키마

**테이블 생성 완료**:
- `execution_results` - 실행 결과 저장
- `shared_content_likes` - 좋아요 기록

**RLS 정책 적용**:
- 본인의 결과물만 CRUD 가능
- 공유된 결과물은 모든 사용자가 조회 가능

---

**작성일**: 2024-12-24
**최종 수정일**: 2024-12-24 (Phase 1-3 구현 완료)
